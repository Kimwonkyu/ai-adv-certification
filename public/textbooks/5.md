# 📘 [학습 노트] 교재 5. RAG & Agent (Search & Automation)

이 교재는 검색 증강 생성(RAG)의 수리적 최적화 기술과 자율적 의사결정을 내리는 에이전트 시스템의 고급 아키텍처를 다룹니다.

---

## 1. 벡터 검색과 인덱싱 아키텍처
대규모 데이터 세트에서 유사한 지식을 초고속으로 인출하기 위한 물리적 저장소와 알고리즘의 이해가 필수적입니다.

### ⚡ HNSW (Hierarchical Navigable Small World)
- **알고리즘**: 데이터를 계층적 그래프 구조로 연결하여 검색 범위를 기하급수적으로 좁히는 ANN(Approximate Nearest Neighbor) 기법입니다.
- **주요 파라미터**:
    - **M**: 각 노드가 가질 수 있는 최대 연결(Edge) 수. 클수록 검색 정밀도는 올라가나 인덱싱 시간과 메모리 사용량이 증가합니다.
    - **ef_construction**: 인덱스 생성 시 탐색할 후보 리스트의 크기. 높을수록 인덱스 품질이 좋아집니다.
    - **ef_search**: 실제 검색 시 탐색 범위를 결정하며, 정밀도와 속도의 트레이드오프(Trade-off)를 조절합니다.

### 🔍 하이브리드 검색과 RRF
- **Sparse (키워드/BM25)** + **Dense (시맨틱/Vector)** 검색의 결합입니다.
- **RRF (Reciprocal Rank Fusion)**: $\text{score} = \sum_{r \in R} \frac{1}{k + r}$ 수식을 사용하여 각 검색 엔진의 '순위'만을 기반으로 결과를 통합합니다. 특정 엔진의 점수 체계에 의존하지 않아 매우 안정적입니다.

---

## 2. 검색 고도화 전략 (Advanced Retrieval)
단순한 벡터 유사도 검색의 한계를 극복하기 위한 정밀화 단계입니다.

### 🚀 리랭킹 (Reranking)
- **Bi-Encoder**: 질문과 문서를 각각 벡터화하여 코사인 유사도를 계산. 매우 빠르지만 문맥적 교호작용(Interaction)이 부족함.
- **Cross-Encoder**: 질문과 문서를 한꺼번에 모델에 넣어 연산. 속도는 느리지만 질문과 문서 사이의 직접적인 어텐션(Full Attention)을 수행하여 **정밀도(Precision)**가 압도적입니다.
- **전략**: Bi-Encoder로 수백 개의 후보를 빠르게 뽑은 뒤, Cross-Encoder로 상위 5~10개를 선별하는 2단계 파이프라인이 표준입니다.

### 🎭 HyDE (Hypothetical Document Embeddings)
- 질문(Query)과 정답 문서(Doc)는 임베딩 공간에서 거리가 멀 수 있습니다. 
- 이를 해결하기 위해 모델이 '가상의 정답'을 먼저 쓰게 하고, 그 가상 정답의 임베딩으로 검색을 수행하여 **의미적 정합성**을 획기적으로 높입니다.

---

## 3. 에이전트 아키텍처와 LangGraph
에이전트는 단순히 도구를 쓰는 것을 넘어 복잡한 상태를 관리하며 스스로 오류를 수정(Self-correction)합니다.

### 🕸 LangGraph: 상태 기반 지향성 그래프
- **Node**: 실제 연산을 수행하는 함수 (생성, 검색, 도구 사용 등).
- **Edge**: 노드 간의 데이터 흐름. 조건부 엣지(Conditional Edge)를 통해 에이전트의 다음 행동을 분기합니다.
- **State**: 에이전트의 전체 작업 이력과 변수들을 담은 객체. 이를 통해 에이전트는 중단된 지점부터 다시 시작하거나 이전 결과를 기억할 수 있습니다.

### 🔄 자기 반성 (Self-Reflection / Reflexion)
- 에이전트가 답변을 생성한 뒤 스스로 "이 답변이 질문과 일치하는가?" 혹은 "추론 과정에 오류가 없는가?"를 평가하는 노드를 거쳐, 필요한 경우 루프를 돌아 계획을 수정하는 고도로 지능화된 구조입니다.

---

## 4. RAG 평가 체계: RAGAS
RAG 시스템의 성능을 단순한 정확도 이상으로 수치화하는 프레임워크입니다.

### 📊 주요 평가지표 (RAGAS Metrics)
- **Faithfulness (충실성)**: 생성된 답변이 검색된 문서(Context) 내에 존재하는 사실들로만 구성되었는가?
- **Answer Relevancy (관련성)**: 답변이 사용자 질문의 의도에 부합하는가?
- **Context Precision (검색 정밀도)**: 검색된 결과 중 상위 결과들에 실제 정답과 연관된 정보가 집중되어 있는가?
- **Context Recall (검색 재현율)**: 정답을 도출하기 위해 필요한 모든 지식이 검색된 결과 내에 포함되어 있는가?

이상의 기법들을 조합하면 Hallucination이 최소화된 상용 서비스 수준의 RAG 에이전트를 구축할 수 있습니다.